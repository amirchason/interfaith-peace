---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';

export async function getStaticPaths() {
  const articles = await getCollection('articles');

  return articles.map(article => ({
    params: {
      slug: article.slug
    },
    props: { article }
  }));
}

type Props = {
  article: CollectionEntry<'articles'>;
};

const { article } = Astro.props;
const { Content } = await article.render();

// Format date
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

// Build breadcrumb
const breadcrumb = [
  { name: 'Home', href: '/' },
  { name: 'Articles', href: '/articles' },
  { name: article.data.title, href: Astro.url.pathname }
];

// Determine category color
const categoryColors: Record<string, string> = {
  'counter-extremism': '#E74C3C',
  'interfaith': '#95A5A6',
  'peace-teachings': '#27AE60',
  'scripture-study': '#3498DB',
  default: '#95A5A6'
};

const categoryColor = categoryColors[article.data.category] || categoryColors.default;
---

<BaseLayout
  title={article.data.title}
  description={article.data.description}
  ogImage={article.data.image}
>
  <!-- Article -->
  <article class="article-page">
    <!-- Hero Section -->
    <ArticleHero
      title={article.data.title}
      description={article.data.description}
      category={article.data.category}
      publishedDate={formatDate(article.data.publishedDate)}
      author={article.data.author}
      image={article.data.image}
      imageAlt={article.data.imageAlt}
      tags={article.data.tags}
    />

    <!-- Article Content -->
    <div class="article-content bg-background-secondary">
      <div class="container mx-auto max-w-4xl px-4 py-12">
        <!-- Breadcrumb -->
        <nav class="breadcrumb mb-8 text-sm" aria-label="Breadcrumb">
          <ol class="flex flex-wrap items-center gap-2">
            {breadcrumb.map((item, index) => (
              <>
                {index > 0 && (
                  <li class="text-text-secondary" aria-hidden="true">/</li>
                )}
                <li>
                  {index === breadcrumb.length - 1 ? (
                    <span class="text-text-secondary" aria-current="page">
                      {item.name}
                    </span>
                  ) : (
                    <a
                      href={item.href}
                      class="text-primary hover:underline transition-colors"
                    >
                      {item.name}
                    </a>
                  )}
                </li>
              </>
            ))}
          </ol>
        </nav>

        <!-- Article Metadata -->
        <div class="article-meta mb-8 pb-6 border-b border-border-light">
          <div class="flex flex-wrap items-center gap-4 text-sm text-text-secondary">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <time datetime={article.data.publishedDate.toISOString()}>
                {formatDate(article.data.publishedDate)}
              </time>
            </div>

            {article.data.updatedDate && (
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Updated {formatDate(article.data.updatedDate)}</span>
              </div>
            )}

            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span>{article.data.author}</span>
            </div>
          </div>

          {article.data.series && (
            <div class="mt-4">
              <span
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium"
                style={`background-color: ${categoryColor}15; color: ${categoryColor};`}
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                {article.data.series} (Part {article.data.seriesOrder})
              </span>
            </div>
          )}
        </div>

        <!-- Main Content -->
        <div class="prose prose-lg max-w-none
          prose-headings:font-heading prose-headings:font-bold
          prose-h1:text-4xl prose-h1:mb-6
          prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-4 prose-h2:border-b prose-h2:border-border-light prose-h2:pb-2
          prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-3
          prose-h4:text-xl prose-h4:mt-6 prose-h4:mb-2
          prose-p:text-text-primary prose-p:leading-relaxed prose-p:mb-4
          prose-a:text-primary prose-a:no-underline hover:prose-a:underline
          prose-strong:text-text-primary prose-strong:font-semibold
          prose-ul:my-4 prose-ul:pl-6
          prose-ol:my-4 prose-ol:pl-6
          prose-li:my-2
          prose-blockquote:border-l-4 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-text-secondary
          prose-code:bg-background-primary prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
          prose-pre:bg-background-primary prose-pre:p-4 prose-pre:rounded-lg prose-pre:overflow-x-auto
          prose-img:rounded-lg prose-img:shadow-md
        ">
          <Content />
        </div>

        <!-- Tags -->
        {article.data.tags && article.data.tags.length > 0 && (
          <div class="tags-section mt-12 pt-8 border-t border-border-light">
            <h3 class="text-sm font-semibold text-text-secondary uppercase mb-4">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {article.data.tags.map(tag => (
                <span class="px-3 py-1 bg-background-primary rounded-full text-sm text-text-secondary hover:bg-border-light transition-colors">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Related Articles -->
        {article.data.relatedArticles && article.data.relatedArticles.length > 0 && (
          <div class="related-articles mt-12 pt-8 border-t border-border-light">
            <h3 class="text-2xl font-bold mb-6">Related Articles</h3>
            <div class="grid md:grid-cols-3 gap-4">
              {article.data.relatedArticles.map(slug => (
                <a
                  href={`/articles/${slug}`}
                  class="p-4 bg-background-primary rounded-lg hover:shadow-lg transition-shadow"
                >
                  <span class="text-primary hover:underline">
                    {slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}
                  </span>
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .article-page {
    min-height: 100vh;
  }

  .article-content {
    background: linear-gradient(180deg, var(--color-background-primary) 0%, var(--color-background-secondary) 100%);
  }
</style>
